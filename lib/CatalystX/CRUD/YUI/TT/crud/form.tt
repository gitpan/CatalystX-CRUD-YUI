[%# generic RHTMLO form generator. %]
[%
# specific a specific field order with the 'fields.order' array.
# the 'readonly' for values that should not be edited
# but should be displayed (as with creation timestamps, etc)
#
# TODO some default JS validation would be nice here.

# DEFAULT didn't work as expected here.
UNLESS fields.defined;
    SET fields = { order = [], readonly = {} };
END;
UNLESS fields.order.size;
    fields.order    = form.field_names_by_rank;
END;
UNLESS fields.readonly.size;
    # common readonly field names for auto-timestamps.
    # to avoid getting these set automatically,
    # set them explicitly in fields.readonly
    # in the .tt that PROCESSes this one
    fields.readonly.ctime = 1;
    fields.readonly.mtime = 1;
    fields.readonly.created = 1;
    fields.readonly.modified = 1;
END;

DEFAULT oid = object_id;
IF (oid);
    oid = c.controller.make_primary_key_string(object) || 0;
END;

USE autoformat( all = 1 );  # for textarea readonly 

%]

[% IF (error || form.error) %]
<div class="error">[% error || form.error %]</div>
[% END %]

[%  FOREACH fname = fields.order;

        field = form.field( fname );
        
        # make sure any serial (autoincrem) fields
        # are skipped. This is a backwards compat fix
        # since RDG used to generate a hidden serial
        # field for autoincrem PKs
        IF (field.class == 'serial' || field.isa('Rose::HTMLx::Form::Field::Serial'));
            NEXT;
        END;
        
        # set DateTime format
        IF field.isa('Rose::HTML::Form::Field::DateTime');
            IF (field.internal_value.epoch.defined);
                CALL field.output_format( yui.serializer.datetime_format );
            END;
        END;

        # read-only fields
        IF (fields.readonly.defined( fname ));
            field.xhtml_label;

            "<span class='input'>";
            IF field.isa('Rose::HTML::Form::Field::TextArea');
                "<pre>"; autoformat( field.output_value ); "</pre>";
            ELSIF field.isa('Rose::HTML::Form::Field::DateTime');
              IF (field.internal_value.epoch.defined);
                field.output_value _ '';
              END;
            ELSIF field.isa('Rose::HTMLx::Form::Field::Boolean');
                field.output_value == '1' ? 'true' : 'false';
            ELSIF field.isa('Rose::HTML::Form::Field::PopUpMenu');
                field.value_label;
            ELSE;
                form.field_value( fname );
            END;
            
            PROCESS related_field_info;
            
            "</span>";
            
            # optionally pass the readonly value through hidden
            # as when creating an object with a FK that is readonly.
            # this only works with values that are not objects themselves.
            IF (fields.readonly.item( fname ) > 1) %]
              <input type="hidden" name="[% fname %]" value="[% field.output_value %]" />
            [% END;
            
            "<br />\n";
        
        # autocomplete magic
        ELSIF (field.can('autocomplete'));
            u = field.url;
            USE url = url( u.0, u.1 );
            SET input = {
                    label  = field.xhtml_label,
                    url    = u.0,
                    params = url.match('\?(.+)$').0.replace('&amp;','&'),
                    id     = 'ac_' _ fname,      # fname will be used as hidden field name
                    fname  = fname,
                    param  = u.1,
                    limit  = field.limit,
                    cache_size = 50,
                    csize  = field.size || 0,
            };
            # if searching, we do not have an object yet.
            IF (object);
                input.value  = field.internal_value || 
                    form.metadata.foreign_field_value( fname, object );
            END;
            PROCESS crud/autocomplete_field.tt;
            "<br />\n";

        # checkboxes
        ELSIF (field.can('xhtml_checkbox'));
            field.xhtml_label;
            field.xhtml_checkbox;
            "<br />\n";
      
        # hidden fields
        ELSIF (field.isa('Rose::HTML::Form::Field::Hidden'));
            IF show_hidden_fields;
                t = form.hidden_to_text_field(field);
                t.xhtml_label;
                t.xhtml;
                "<br />\n";
            ELSE;
                field.xhtml;
            END;
                  
                               
        # default
        ELSE;
                        
            field.xhtml_label;
            field.xhtml;
            PROCESS related_field_info;
            "<br />\n";
            
        END;    # IF/ELSE        
    END;  # FOREACH
        
%]

[% BLOCK related_field_info %]
[%
 IF (     object
      &&  form.metadata.show_related_fields 
      &&  field.internal_value.length
      &&  form.metadata.is_related_field( fname ) 
      &&  !c.controller.primary_key.grep( "^$fname$" ).size
    );
  SET rel_info      = form.metadata.related_field( fname );
  CALL rel_info.get_controller;
  SET foreign_field = form.metadata.show_related_field_using( rel_info.foreign_class, fname );  
  SET foreign_key   = rel_info.foreign_column_for(fname);
  SET method        = rel_info.method;
  
  # default search since may be null or o2m
  SET myurl         = c.uri_for( rel_info.controller.action_for('search'), { $foreign_key = field.internal_value } );

  IF (foreign_field);
    # show related record value literally
    myval           = object.$method.$foreign_field;
    myval_uri_safe  = myval | uri;
    
    SET base_foreign_url = c.uri_for('/' _ rel_info.controller.path_prefix);
    
    # change to link directly to foreign object
    # must check if controller isa REST controller as URI format is different
    IF (rel_info.controller.isa('CatalystX::CRUD::REST'));
        myurl = base_foreign_url _ '/' _ myval_uri_safe;
    ELSE;
        myurl = base_foreign_url _ '/' _ myval_uri_safe _ '/' _ rel_info.controller.can_write(c) ? 'edit' : 'view';
    END;
    
    IF myval.length;
        "&nbsp;<a class='box' href='$myurl'>$myval</a>";
    END;
  ELSE;
     # show link to related record
    "&nbsp;<a class='box' href='$myurl'>Related record</a>";
  END;
  
 END;
%]
[% END %]
